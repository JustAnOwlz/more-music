metadata:
  name: moremusic
spec:
  handler: "main:handler"
  runtime: nodejs
  env:
    - name: API_KEY_LASTFM
      value: "YOUR_API_KEY_HERE"
    - name: API_KEY_YOUTUBE
      value: "YOUR_API_KEY_HERE"
    - name: API_KEY_IFTTT
      value: "YOUR_API_KEY_HERE"
    - name: IP
      value: "YOUR_IP_HERE"
  resources: {}
  image: "nuclio/processor-moremusic:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 80
  triggers:
    themusictrigger:
      kind: mqtt
      attributes:
        subscriptions:
          - topic: iot/moremusic
            qos: 0
      workerAllocatorName: ""
      url: "guest:guest@**INSERT HERE YOUR IP**:1883"
  version: 1
  build:
    image: ""
    noCache: false
    offline: false
    dependencies: []
    runtimeAttributes:
      repositories: []
    functionSourceCode: Y29uc3QgYW1xcCA9IHJlcXVpcmUoJ2FtcXBsaWInKTsNCmNvbnN0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKQ0KDQoNCmNvbnN0IFFVRVVFX0xPR0dFUiA9ICdpb3QvbG9nZ2VyJzsNCmNvbnN0IElQID0gcHJvY2Vzcy5lbnYuSVA7DQpjb25zdCBBUElfS0VZX0xBU1RGTSA9IHByb2Nlc3MuZW52LkFQSV9LRVlfTEFTVEZNOw0KY29uc3QgQVBJX0tFWV9ZT1VUVUJFID0gcHJvY2Vzcy5lbnYuQVBJX0tFWV9ZT1VUVUJFOw0KY29uc3QgQVBJX0tFWV9JRlRUVCA9IHByb2Nlc3MuZW52LkFQSV9LRVlfSUZUVFQ7DQoNCg0KbGV0IGJ1aWxkUmVxdWVzdCA9IGZ1bmN0aW9uKHVybCwgZGF0YSkgew0KCWNvbnN0IHBhcmFtcyA9IHR5cGVvZiBkYXRhID09ICdzdHJpbmcnID8gZGF0YSA6IE9iamVjdC5rZXlzKGRhdGEpLm1hcCgNCgkJeCA9PiBgJHtlbmNvZGVVUklDb21wb25lbnQoeCl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFbeF0pfWANCgkpLmpvaW4oJyYnKTsNCg0KCXJldHVybiBgJHt1cmx9PyR7cGFyYW1zfWA7DQp9DQoNCg0KbGV0IHNlbmRSZXF1ZXN0ID0gYXN5bmMgZnVuY3Rpb24ocmVxVXJsLCBwYXJhbWV0ZXJzKSB7DQoJcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgew0KCQlodHRwcy5nZXQoYnVpbGRSZXF1ZXN0KHJlcVVybCwgcGFyYW1ldGVycyksIGZ1bmN0aW9uKHJlc291cmNlKSB7DQoJCQlib2R5ID0gIiINCgkJCXJlc291cmNlLnNldEVuY29kaW5nKCd1dGY4Jyk7DQoNCgkJCXJlc291cmNlLm9uKCdlbmQnLCAoKSA9PiB7DQoJCQkJcmVzb2x2ZShib2R5KTsNCgkJCX0pOw0KDQoJCQlyZXNvdXJjZS5vbignZGF0YScsIChkYXRhKSA9PiB7DQoJCQkJYm9keSArPSBkYXRhOw0KCQkJfSk7DQoNCg0KCQl9KS5vbignZXJyb3InLCAoZXJyKSA9PiB7DQoJCQlyZWplY3QoZXJyLm1lc3NhZ2UpOw0KCQl9KQ0KCX0pDQp9DQoNCmxldCBmZXRjaEFQSXMgPSBhc3luYyBmdW5jdGlvbihzb25nKSB7DQoJdHJ5IHsNCgkJY29uc3Qgc29uZ3NGb3VuZCA9IGF3YWl0IHNlYXJjaExhc3RGTShzb25nKTsNCgkJY29uc3QgbGlua3NGb3VuZCA9IGF3YWl0IHNlYXJjaFlvdVR1YmUoc29uZ3NGb3VuZCk7DQoJCXJldHVybiBsaW5rc0ZvdW5kOw0KCX0gY2F0Y2ggKGUpIHsNCgkJc2VuZEZlZWRiYWNrKGBFcnJvciB3aGlsZSBmZXRjaGluZ2ApDQoJCXRocm93IChgRXJyb3IgZHVyaW5nIHRoZSBmZXRjaEFQSXMgY2FsbDogJHtlfWApOw0KCX0NCn0NCg0KbGV0IHNlbmRJRlRUVCA9IGFzeW5jIGZ1bmN0aW9uKGxpbmtzKSB7DQoJbGV0IGV2ZW50TmFtZSA9ICJtb3JlbXVzaWMiOw0KCWxldCByZXFVcmwgPSBgaHR0cHM6Ly9tYWtlci5pZnR0dC5jb20vdHJpZ2dlci8ke2V2ZW50TmFtZX0vd2l0aC9rZXkvJHtBUElfS0VZX0lGVFRUfWANCg0KCWxldCBwcm9taXNlc01hZGUgPSBbXTsNCglmb3IgKHZhciBpID0gMDsgaSA8IGxpbmtzLmxlbmd0aDsgaSsrKSB7DQoJCWxldCBwYXJhbWV0ZXJzID0ge307DQoJCXBhcmFtZXRlcnNbYHZhbHVlMWBdID0gbGlua3NbaV1bIm5hbWUiXTsNCgkJcGFyYW1ldGVyc1tgdmFsdWUyYF0gPSBsaW5rc1tpXVsibGluayJdOw0KCQlwYXJhbWV0ZXJzW2B2YWx1ZTNgXSA9IGAke2krMX0vJHtsaW5rcy5sZW5ndGh9YDsNCgkJcHJvbWlzZXNNYWRlLnB1c2goc2VuZFJlcXVlc3QocmVxVXJsLCBwYXJhbWV0ZXJzKSk7DQoJfQ0KDQoJYXdhaXQgc2VuZEZlZWRiYWNrKGBJRlRUVCBkb25lYCkNCg0KCXJldHVybiBhd2FpdCBQcm9taXNlLmFsbChwcm9taXNlc01hZGUpOw0KfQ0KDQpsZXQgc2VhcmNoTGFzdEZNID0gYXN5bmMgZnVuY3Rpb24oc29uZykgew0KCWxldCBwYXJhbWV0ZXJzID0gew0KCQlhcGlfa2V5OiBBUElfS0VZX0xBU1RGTSwNCgkJYXJ0aXN0OiBzb25nWzBdLA0KCQl0cmFjazogc29uZ1sxXSwNCgkJbWV0aG9kOiAidHJhY2suZ2V0c2ltaWxhciIsDQoJCWZvcm1hdDogImpzb24iDQoJfTsNCg0KCWxldCByZXFVcmwgPSAiaHR0cHM6Ly93cy5hdWRpb3Njcm9iYmxlci5jb20vMi4wLyI7DQoNCglsZXQgcmVxID0gYXdhaXQgc2VuZFJlcXVlc3QocmVxVXJsLCBwYXJhbWV0ZXJzKTsNCglsZXQgalJlc3BvbnNlOw0KCXRyeSB7DQoJCWpSZXNwb25zZSA9IEpTT04ucGFyc2UocmVxKS5zaW1pbGFydHJhY2tzOw0KCX0gY2F0Y2ggKGUpIHsNCgkJdGhyb3cgKGBZb3V0dWJlIHBhcnNpbmcgZXhjZXB0aW9uOiAke2V9XG5cbkJvZHkgb2YgdGhlIHJlcXVlc3Q6ICR7cmVxfWApOw0KCX0NCglsZXQgc29uZ3MgPSBbXTsNCglmb3IgKGxldCBpID0gMDsgaSA8IDU7IGkrKykgew0KCQlzb25ncy5wdXNoKGAke2pSZXNwb25zZS50cmFja1tgJHtpfWBdLmFydGlzdC5uYW1lfSAtICR7alJlc3BvbnNlLnRyYWNrW2Ake2l9YF0ubmFtZX1gKQ0KCX0NCg0KCWF3YWl0IHNlbmRGZWVkYmFjayhgTGFzdEZNIGRvbmVgKQ0KCXJldHVybiBzb25nczsNCn0NCg0KbGV0IHNlYXJjaFlvdVR1YmUgPSBhc3luYyBmdW5jdGlvbihzb25nTmFtZXMpIHsNCglsZXQgcGFyYW1ldGVycyA9IHsNCgkJa2V5OiBBUElfS0VZX1lPVVRVQkUsDQoJCXBhcnQ6ICJzbmlwcGV0IiwNCgkJcTogIiINCgl9Ow0KDQoJbGV0IHJlcVVybCA9ICJodHRwczovL3d3dy5nb29nbGVhcGlzLmNvbS95b3V0dWJlL3YzL3NlYXJjaCI7DQoNCglsZXQgbGlua3MgPSBbXTsNCglmb3IgKHZhciBpID0gMDsgaSA8IHNvbmdOYW1lcy5sZW5ndGg7IGkrKykgew0KCQlwYXJhbWV0ZXJzLnEgPSBzb25nTmFtZXNbaV07DQoJCWxldCByZXEgPSBhd2FpdCBzZW5kUmVxdWVzdChyZXFVcmwsIHBhcmFtZXRlcnMpOw0KDQoJCWxldCBwYXJzZWQ7DQoJCXRyeSB7DQoJCQlwYXJzZWQgPSBKU09OLnBhcnNlKHJlcSkNCgkJfSBjYXRjaCAoZSkgew0KCQkJdGhyb3cgKGBZb3V0dWJlIHBhcnNpbmcgZXhjZXB0aW9uOiAke2V9XG5cbkJvZHkgb2YgdGhlIHJlcXVlc3Q6ICR7cmVxfWApOw0KCQl9DQoNCgkJbGV0IGwgPSBwYXJzZWQuaXRlbXNbMF0uaWQudmlkZW9JZDsNCgkJbGlua3MucHVzaCh7DQoJCQkibmFtZSI6IHNvbmdOYW1lc1tpXSwNCgkJCSJsaW5rIjogYGh0dHBzOi8veW91dHUuYmUvJHtsfWANCgkJfSk7DQoJfQ0KDQoJYXdhaXQgc2VuZEZlZWRiYWNrKGBZb3V0dWJlIGRvbmVgKQ0KCXJldHVybiBsaW5rczsNCg0KfQ0KDQpsZXQgc2VuZEZlZWRiYWNrID0gYXN5bmMgKG1zZykgPT4gew0KCWNvbnN0IGNvbm5lY3Rpb24gPSBhd2FpdCBhbXFwLmNvbm5lY3QoYGFtcXA6Ly9ndWVzdDpndWVzdEAke0lQfTo1NjcyYCk7DQoJY29uc3QgY2ggPSBhd2FpdCBjb25uZWN0aW9uLmNyZWF0ZUNoYW5uZWwoKQ0KCWF3YWl0IGNoLmFzc2VydFF1ZXVlKFFVRVVFX0xPR0dFUiwge2R1cmFibGU6IGZhbHNlfSk7DQoJYXdhaXQgY2guc2VuZFRvUXVldWUoUVVFVUVfTE9HR0VSLCBCdWZmZXIuZnJvbShtc2cpKTsNCn0NCg0KZXhwb3J0cy5oYW5kbGVyID0gZnVuY3Rpb24oY29udGV4dCwgZXZlbnQpIHsNCglsZXQgX2V2ZW50ID0gSlNPTi5wYXJzZShKU09OLnN0cmluZ2lmeShldmVudCkpOw0KCWxldCBfZGF0YSA9IFN0cmluZy5mcm9tQ2hhckNvZGUoLi4uX2V2ZW50LmJvZHkuZGF0YSk7DQoNCgljb25zdCBzb25nID0gX2RhdGEuc3BsaXQoJy0nKS5tYXAoeCA9PiB4LnRyaW0oKSk7DQoNCglpZiAoc29uZy5sZW5ndGggIT0gMikgew0KCQlzZW5kRmVlZGJhY2soYEVycm9yIHdoaWxlIGxvYWRpbmcgdGhlIHNvbmcsICR7X2RhdGF9IGlzIG5vdCB2YWxpZGApDQoJCQkudGhlbih4ID0+IHgpDQoJCXJldHVybg0KCX1lbHNlew0KCQlzZW5kRmVlZGJhY2soYFNvbmcgbG9hZGVkOiAke3Nvbmcuam9pbignIC0gJyl9YCkNCgkJCS50aGVuKHggPT4geCkNCgl9DQoNCglmZXRjaEFQSXMoc29uZykNCgkJLnRoZW4obGlua3MgPT4gc2VuZElGVFRUKGxpbmtzKSkNCgkJLnRoZW4ob3V0cHV0ID0+IGNvbnRleHQuY2FsbGJhY2soIkRvbmUiKSkNCgkJLmNhdGNoKGVyciA9PiBjb250ZXh0LmNhbGxiYWNrKCJFcnJvcjogIiwgZXJyKSk7DQoNCn0=
    commands:
      - 'npm install amqplib'
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
