metadata:
  name: moremusic
  labels:
    nuclio.io/project-name: f376ceb7-0af0-4bbb-aa42-f5775b134879
spec:
  handler: "main:handler"
  runtime: nodejs
  env:
  - name: API_KEY_LASTFM
    value: "*YOUR_KEY_HERE*"
  - name: API_KEY_YOUTUBE
    value: "*YOUR_KEY_HERE*"
  - name: API_KEY_IFTTT
    value: "*YOUR_KEY_HERE*"
  - name: IP
    value: "*YOUR_IP_HERE*"
  resources: {}
  image: "nuclio/processor-moremusic:latest"
  minReplicas: 1
  maxReplicas: 1
  targetCPU: 80
  triggers:
    themusictrigger:
      class: ""
      kind: mqtt
      url: "guest:guest@*YOUR_IP_HERE*:1883"
      attributes:
        subscriptions:
          - qos: 0
            topic: iot/moremusic
  build:
    functionSourceCode: Y29uc3QgYW1xcCA9IHJlcXVpcmUoJ2FtcXBsaWInKTsNCmNvbnN0IGh0dHBzID0gcmVxdWlyZSgnaHR0cHMnKQ0KDQoNCmNvbnN0IFFVRVVFX0xPR0dFUiA9ICdpb3QvbG9nZ2VyJzsNCmNvbnN0IElQID0gcHJvY2Vzcy5lbnYuSVA7DQpjb25zdCBBUElfS0VZX0xBU1RGTSA9IHByb2Nlc3MuZW52LkFQSV9LRVlfTEFTVEZNOw0KY29uc3QgQVBJX0tFWV9ZT1VUVUJFID0gcHJvY2Vzcy5lbnYuQVBJX0tFWV9ZT1VUVUJFOw0KY29uc3QgQVBJX0tFWV9JRlRUVCA9IHByb2Nlc3MuZW52LkFQSV9LRVlfSUZUVFQ7DQoNCg0KbGV0IGJ1aWxkUmVxdWVzdCA9IGZ1bmN0aW9uKHVybCwgZGF0YSkgew0KCWNvbnN0IHBhcmFtcyA9IHR5cGVvZiBkYXRhID09ICdzdHJpbmcnID8gZGF0YSA6IE9iamVjdC5rZXlzKGRhdGEpLm1hcCgNCgkJeCA9PiBgJHtlbmNvZGVVUklDb21wb25lbnQoeCl9PSR7ZW5jb2RlVVJJQ29tcG9uZW50KGRhdGFbeF0pfWANCgkpLmpvaW4oJyYnKTsNCg0KCXJldHVybiBgJHt1cmx9PyR7cGFyYW1zfWA7DQp9DQoNCg0KbGV0IHNlbmRSZXF1ZXN0ID0gYXN5bmMgZnVuY3Rpb24ocmVxVXJsLCBwYXJhbWV0ZXJzKSB7DQoJcmV0dXJuIG5ldyBQcm9taXNlKGZ1bmN0aW9uKHJlc29sdmUsIHJlamVjdCkgew0KCQlodHRwcy5nZXQoYnVpbGRSZXF1ZXN0KHJlcVVybCwgcGFyYW1ldGVycyksIGZ1bmN0aW9uKHJlc291cmNlKSB7DQoJCQlib2R5ID0gIiINCgkJCXJlc291cmNlLnNldEVuY29kaW5nKCd1dGY4Jyk7DQoNCgkJCXJlc291cmNlLm9uKCdlbmQnLCAoKSA9PiB7DQoJCQkJcmVzb2x2ZShib2R5KTsNCgkJCX0pOw0KDQoJCQlyZXNvdXJjZS5vbignZGF0YScsIChkYXRhKSA9PiB7DQoJCQkJYm9keSArPSBkYXRhOw0KCQkJfSk7DQoNCg0KCQl9KS5vbignZXJyb3InLCAoZXJyKSA9PiB7DQoJCQlyZWplY3QoZXJyLm1lc3NhZ2UpOw0KCQl9KQ0KCX0pDQp9DQoNCmxldCBmZXRjaEFQSXMgPSBhc3luYyBmdW5jdGlvbihzb25nKSB7DQoJdHJ5IHsNCgkJY29uc3Qgc29uZ3NGb3VuZCA9IGF3YWl0IHNlYXJjaExhc3RGTShzb25nKTsNCgkJY29uc3QgbGlua3NGb3VuZCA9IGF3YWl0IHNlYXJjaFlvdVR1YmUoc29uZ3NGb3VuZCk7DQoJCXJldHVybiBsaW5rc0ZvdW5kOw0KCX0gY2F0Y2ggKGUpIHsNCgkJdGhyb3cgKGBFcnJvciBkdXJpbmcgdGhlIGZldGNoQVBJcyBjYWxsOiAke2V9YCk7DQoJCXJldHVybiBlOw0KCX0NCn0NCg0KbGV0IHNlbmRJRlRUVCA9IGFzeW5jIGZ1bmN0aW9uKGxpbmtzKSB7DQoJbGV0IGV2ZW50TmFtZSA9ICJtb3JlbXVzaWMiOw0KCWxldCByZXFVcmwgPSBgaHR0cHM6Ly9tYWtlci5pZnR0dC5jb20vdHJpZ2dlci8ke2V2ZW50TmFtZX0vd2l0aC9rZXkvJHtBUElfS0VZX0lGVFRUfWANCg0KCWxldCBwcm9taXNlc01hZGUgPSBbXTsNCglmb3IgKHZhciBpID0gMDsgaSA8IGxpbmtzLmxlbmd0aDsgaSsrKSB7DQoJCWxldCBwYXJhbWV0ZXJzID0ge307DQoJCXBhcmFtZXRlcnNbYHZhbHVlMWBdID0gbGlua3NbaV1bIm5hbWUiXTsNCgkJcGFyYW1ldGVyc1tgdmFsdWUyYF0gPSBsaW5rc1tpXVsibGluayJdOw0KCQlwYXJhbWV0ZXJzW2B2YWx1ZTNgXSA9IGAke2krMX0vJHtsaW5rcy5sZW5ndGh9YDsNCgkJcHJvbWlzZXNNYWRlLnB1c2goc2VuZFJlcXVlc3QocmVxVXJsLCBwYXJhbWV0ZXJzKSk7DQoJfQ0KDQoJcmV0dXJuIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzTWFkZSk7DQp9DQoNCmxldCBzZWFyY2hMYXN0Rk0gPSBhc3luYyBmdW5jdGlvbihzb25nKSB7DQoJbGV0IHBhcmFtZXRlcnMgPSB7DQoJCWFwaV9rZXk6IEFQSV9LRVlfTEFTVEZNLA0KCQlhcnRpc3Q6IHNvbmdbMF0sDQoJCXRyYWNrOiBzb25nWzFdLA0KCQltZXRob2Q6ICJ0cmFjay5nZXRzaW1pbGFyIiwNCgkJZm9ybWF0OiAianNvbiINCgl9Ow0KDQoJbGV0IHJlcVVybCA9ICJodHRwczovL3dzLmF1ZGlvc2Nyb2JibGVyLmNvbS8yLjAvIjsNCg0KCWxldCByZXEgPSBhd2FpdCBzZW5kUmVxdWVzdChyZXFVcmwsIHBhcmFtZXRlcnMpOw0KCWxldCBqUmVzcG9uc2U7DQoJdHJ5IHsNCgkJalJlc3BvbnNlID0gSlNPTi5wYXJzZShyZXEpLnNpbWlsYXJ0cmFja3M7DQoJfSBjYXRjaCAoZSkgew0KCQl0aHJvdyAoYFlvdXR1YmUgcGFyc2luZyBleGNlcHRpb246ICR7ZX1cblxuQm9keSBvZiB0aGUgcmVxdWVzdDogJHtyZXF9YCk7DQoJfQ0KCWxldCBzb25ncyA9IFtdOw0KCWZvciAobGV0IGkgPSAwOyBpIDwgNTsgaSsrKSB7DQoJCXNvbmdzLnB1c2goYCR7alJlc3BvbnNlLnRyYWNrW2Ake2l9YF0uYXJ0aXN0Lm5hbWV9IC0gJHtqUmVzcG9uc2UudHJhY2tbYCR7aX1gXS5uYW1lfWApDQoJfQ0KDQoJcmV0dXJuIHNvbmdzOw0KfQ0KDQpsZXQgc2VhcmNoWW91VHViZSA9IGFzeW5jIGZ1bmN0aW9uKHNvbmdOYW1lcykgew0KCWxldCBwYXJhbWV0ZXJzID0gew0KCQlrZXk6IEFQSV9LRVlfWU9VVFVCRSwNCgkJcGFydDogInNuaXBwZXQiLA0KCQlxOiAiIg0KCX07DQoNCglsZXQgcmVxVXJsID0gImh0dHBzOi8vd3d3Lmdvb2dsZWFwaXMuY29tL3lvdXR1YmUvdjMvc2VhcmNoIjsNCg0KCWxldCBsaW5rcyA9IFtdOw0KCWZvciAodmFyIGkgPSAwOyBpIDwgc29uZ05hbWVzLmxlbmd0aDsgaSsrKSB7DQoJCXBhcmFtZXRlcnMucSA9IHNvbmdOYW1lc1tpXTsNCgkJbGV0IHJlcSA9IGF3YWl0IHNlbmRSZXF1ZXN0KHJlcVVybCwgcGFyYW1ldGVycyk7DQoNCgkJbGV0IHBhcnNlZDsNCgkJdHJ5IHsNCgkJCXBhcnNlZCA9IEpTT04ucGFyc2UocmVxKQ0KCQl9IGNhdGNoIChlKSB7DQoJCQl0aHJvdyAoYFlvdXR1YmUgcGFyc2luZyBleGNlcHRpb246ICR7ZX1cblxuQm9keSBvZiB0aGUgcmVxdWVzdDogJHtyZXF9YCk7DQoJCX0NCg0KCQlsZXQgbCA9IHBhcnNlZC5pdGVtc1swXS5pZC52aWRlb0lkOw0KCQlsaW5rcy5wdXNoKHsNCgkJCSJuYW1lIjogc29uZ05hbWVzW2ldLA0KCQkJImxpbmsiOiBgaHR0cHM6Ly95b3V0dS5iZS8ke2x9YA0KCQl9KTsNCgl9DQoNCglyZXR1cm4gbGlua3M7DQoNCn0NCg0KbGV0IHNlbmRGZWVkYmFjayA9IGFzeW5jIChtc2cpID0+IHsNCgl0cnl7DQoJCWxldCBjb25uZWN0aW9uID0gYXdhaXQgYW1xcC5jb25uZWN0KGBhbXFwOi8vZ3Vlc3Q6Z3Vlc3RAJHtJUH06NTY3MmApOw0KCQlsZXQgY2hhbm5lbCA9IGF3YWl0IGNvbm4uY3JlYXRlQ2hhbm5lbCgpOw0KCQl2YXIgb2sgPSBhd2FpdCBjaC5hc3NlcnRRdWV1ZShRVUVVRV9MT0dHRVIsIHtkdXJhYmxlOiBmYWxzZX0pOw0KDQoJCWNoYW5uZWwuc2VuZFRvUXVldWUoUVVFVUVfTE9HR0VSLCBCdWZmZXIuZnJvbShtc2cpKTsNCgkJY29uc29sZS5sb2coIiBbeF0gTWVzc2FnZSBzZW50OiAnJXMnIiwgbXNnKTsNCgkJY2guY2xvc2UoKTsNCgl9IGZpbmFsbHl7DQoJCWNvbm4uY2xvc2UoKTsNCgl9DQp9DQoNCmV4cG9ydHMuaGFuZGxlciA9IGZ1bmN0aW9uKGNvbnRleHQsIGV2ZW50KSB7DQoJbGV0IF9ldmVudCA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkoZXZlbnQpKTsNCglsZXQgX2RhdGEgPSBTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLl9ldmVudC5ib2R5LmRhdGEpOw0KDQoJY29uc3Qgc29uZyA9IF9kYXRhLnNwbGl0KC9cdyotXHcqL2cpLm1hcCh4ID0+IHgudHJpbSgpKTsNCg0KCWlmIChzb25nLmxlbmd0aCAhPSAyKSB7DQoJCS8vVE9ETzogbGFuY2lhcmUgZXJyb3JlLCBtYWdhcmkgY29uIGlsIGxvZ2dlcg0KCX0NCglzZW5kRmVlZGJhY2soc29uZy50b1N0cmluZygpKQ0KDQoJZmV0Y2hBUElzKHNvbmcpDQoJCS50aGVuKGxpbmtzID0+IHNlbmRJRlRUVChsaW5rcykpDQoJCS50aGVuKG91dHB1dCA9PiBjb250ZXh0LmNhbGxiYWNrKCJEb25lIikpDQoJCS5jYXRjaChlcnIgPT4gY29udGV4dC5jYWxsYmFjaygiRXJyb3I6ICIsIGVycikpOw0KfQ==
    commands:
      - 'npm install amqplib'
    runtimeAttributes:
      repositories: []
    codeEntryType: sourceCode
  platform: {}
  readinessTimeoutSeconds: 60
  version: 1
